ARCH_I386 = i386
ARCH_X86_64 = x86_64
ARCH_ARMV7 = armv7
ARCH_ARMV7S = armv7s
ARCH_ARM64 = arm64

PLAT_MACOS = macos
PLAT_SIMULATOR = sim
PLAT_IOS = ios

ifeq ($(debug), true)
DEBUG_FLAG = debug=true
else
DEBUG_FLAG =
endif

ifeq ($(shared), true)
dynamic = true
endif

ifeq ($(dynamic), true)
LIB_EXT = dylib
else
LIB_EXT = a
endif

DESTLUALIB = liblua
DESTLIMAXLUALIB = liblimaxlua

DESTLUALIBS_MACOS = $(DESTLUALIB).$(PLAT_MACOS).$(ARCH_I386).$(LIB_EXT) $(DESTLUALIB).$(PLAT_MACOS).$(ARCH_X86_64).$(LIB_EXT)
DESTLUALIBS_IOS = $(DESTLUALIB).$(PLAT_SIMULATOR).$(ARCH_I386).$(LIB_EXT) $(DESTLUALIB).$(PLAT_SIMULATOR).$(ARCH_X86_64).$(LIB_EXT) \
        $(DESTLUALIB).$(PLAT_IOS).$(ARCH_ARMV7).$(LIB_EXT) $(DESTLUALIB).$(PLAT_IOS).$(ARCH_ARMV7S).$(LIB_EXT) $(DESTLUALIB).$(PLAT_IOS).$(ARCH_ARM64).$(LIB_EXT)

DESTLIMAXLUALIBS_MACOS = $(DESTLIMAXLUALIB).$(PLAT_MACOS).$(ARCH_I386).$(LIB_EXT) $(DESTLIMAXLUALIB).$(PLAT_MACOS).$(ARCH_X86_64).$(LIB_EXT)
DESTLIMAXLUALIBS_IOS = $(DESTLIMAXLUALIB).$(PLAT_SIMULATOR).$(ARCH_I386).$(LIB_EXT) $(DESTLIMAXLUALIB).$(PLAT_SIMULATOR).$(ARCH_X86_64).$(LIB_EXT) \
        $(DESTLIMAXLUALIB).$(PLAT_IOS).$(ARCH_ARMV7).$(LIB_EXT) $(DESTLIMAXLUALIB).$(PLAT_IOS).$(ARCH_ARMV7S).$(LIB_EXT) 
DESTLIMAXLUALIBS_ARM64 = $(DESTLIMAXLUALIB).$(PLAT_IOS).$(ARCH_ARM64).$(LIB_EXT)

DEVELOPER_MACOS = /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer
SDKPATH_MACOS = $(DEVELOPER_MACOS)/SDKs/MacOSX10.11.sdk

DEVELOPER_IOS = /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer
SDKPATH_IOS = $(DEVELOPER_IOS)/SDKs/iPhoneOS.sdk
DEVELOPER_SIMULATOR = /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer
SDKPATH_SIMULATOR = $(DEVELOPER_SIMULATOR)/SDKs/iPhoneSimulator.sdk

ifeq ($(dynamic), true)
LIBTOOL_MACOS = ld
LIBTOOL_IOS = ld #$(DEVELOPER_IOS)/usr/bin/ld
LIBTOOL_SIMULATOR = ld #$(DEVELOPER_SIMULATOR)/usr/bin/ld
else
LIBTOOL_MACOS = libtool
LIBTOOL_IOS = libtool #$(DEVELOPER_IOS)/usr/bin/libtool
LIBTOOL_SIMULATOR = libtool
endif

LIB_LUA_MACOS_I386_VARS = DESTLUALIB=$(DESTLUALIB) ARCHFLAG=$(ARCH_I386) PLATFLAG=$(PLAT_MACOS) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_MACOS) SDKPATH=$(SDKPATH_MACOS) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_MACOS)
LIB_LUA_MACOS_X86_64_VARS = DESTLUALIB=$(DESTLUALIB) ARCHFLAG=$(ARCH_X86_64) PLATFLAG=$(PLAT_MACOS) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_MACOS) SDKPATH=$(SDKPATH_MACOS) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_MACOS)
LIB_LUA_IOS_ARMV7_VARS = DESTLUALIB=$(DESTLUALIB) ARCHFLAG=$(ARCH_ARMV7) PLATFLAG=$(PLAT_IOS) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_IOS) SDKPATH=$(SDKPATH_IOS) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_IOS)
LIB_LUA_IOS_ARMV7S_VARS = DESTLUALIB=$(DESTLUALIB) ARCHFLAG=$(ARCH_ARMV7S) PLATFLAG=$(PLAT_IOS) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_IOS) SDKPATH=$(SDKPATH_IOS) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_IOS)
LIB_LUA_IOS_ARM64_VARS = DESTLUALIB=$(DESTLUALIB) ARCHFLAG=$(ARCH_ARM64) PLATFLAG=$(PLAT_IOS) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_IOS) SDKPATH=$(SDKPATH_IOS) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_IOS)
LIB_LUA_SIMULATOR_I386_VARS = DESTLUALIB=$(DESTLUALIB) ARCHFLAG=$(ARCH_I386) PLATFLAG=$(PLAT_SIMULATOR) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_SIMULATOR) SDKPATH=$(SDKPATH_SIMULATOR) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_SIMULATOR)
LIB_LUA_SIMULATOR_X86_64_VARS = DESTLUALIB=$(DESTLUALIB) ARCHFLAG=$(ARCH_X86_64) PLATFLAG=$(PLAT_SIMULATOR) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_SIMULATOR) SDKPATH=$(SDKPATH_SIMULATOR) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_SIMULATOR)

LIB_LIMAXLUA_MACOS_I386_VARS = DESTLIMAXLUALIB=$(DESTLIMAXLUALIB) ARCHFLAG=$(ARCH_I386) PLATFLAG=$(PLAT_MACOS) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_MACOS) SDKPATH=$(SDKPATH_MACOS) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_MACOS) DESTLUALIB=$(DESTLUALIB)
LIB_LIMAXLUA_MACOS_X86_64_VARS = DESTLIMAXLUALIB=$(DESTLIMAXLUALIB) ARCHFLAG=$(ARCH_X86_64) PLATFLAG=$(PLAT_MACOS) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_MACOS) SDKPATH=$(SDKPATH_MACOS) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_MACOS) DESTLUALIB=$(DESTLUALIB)
LIB_LIMAXLUA_IOS_ARMV7_VARS = DESTLIMAXLUALIB=$(DESTLIMAXLUALIB) ARCHFLAG=$(ARCH_ARMV7) PLATFLAG=$(PLAT_IOS) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_IOS) SDKPATH=$(SDKPATH_IOS) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_IOS) DESTLUALIB=$(DESTLUALIB)
LIB_LIMAXLUA_IOS_ARMV7S_VARS = DESTLIMAXLUALIB=$(DESTLIMAXLUALIB) ARCHFLAG=$(ARCH_ARMV7S) PLATFLAG=$(PLAT_IOS) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_IOS) SDKPATH=$(SDKPATH_IOS) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_IOS) DESTLUALIB=$(DESTLUALIB)
LIB_LIMAXLUA_IOS_ARM64_VARS = DESTLIMAXLUALIB=$(DESTLIMAXLUALIB) ARCHFLAG=$(ARCH_ARM64) PLATFLAG=$(PLAT_IOS) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_IOS) SDKPATH=$(SDKPATH_IOS) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_IOS) DESTLUALIB=$(DESTLUALIB)
LIB_LIMAXLUA_SIMULATOR_I386_VARS = DESTLIMAXLUALIB=$(DESTLIMAXLUALIB) ARCHFLAG=$(ARCH_I386) PLATFLAG=$(PLAT_SIMULATOR) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_SIMULATOR) SDKPATH=$(SDKPATH_SIMULATOR) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_SIMULATOR) DESTLUALIB=$(DESTLUALIB)
LIB_LIMAXLUA_SIMULATOR_X86_64_VARS = DESTLIMAXLUALIB=$(DESTLIMAXLUALIB) ARCHFLAG=$(ARCH_X86_64) PLATFLAG=$(PLAT_SIMULATOR) LIB_EXT=$(LIB_EXT) DEVELOPER=$(DEVELOPER_SIMULATOR) SDKPATH=$(SDKPATH_SIMULATOR) dynamic=$(dynamic) $(DEBUG_FLAG) LIBTOOL=$(LIBTOOL_SIMULATOR) DESTLUALIB=$(DESTLUALIB)

LIPO_MACOS = lipo
LIPO_IOS = lipo #$(DEVELOPER_IOS)/usr/bin/lipo

ifeq ($(dynamic), true)
LUALIB_DEPS = $(DESTLUALIBS_MACOS) $(DESTLUALIBS_IOS)
MAIN_DEPS = liblimax $(LUALIB_DEPS) $(DESTLIMAXLUALIBS_MACOS) $(DESTLIMAXLUALIBS_IOS)
else
LUALIB_DEPS = $(DESTLUALIB).$(PLAT_MACOS).$(LIB_EXT) $(DESTLUALIB).$(PLAT_IOS).$(LIB_EXT)
MAIN_DEPS = $(LUALIB_DEPS) $(DESTLIMAXLUALIB).$(PLAT_MACOS).$(LIB_EXT) $(DESTLIMAXLUALIB).$(PLAT_IOS).$(LIB_EXT)
endif

main : $(MAIN_DEPS)

liblimax :
	make -C ../../../cpp/limax/macos.clang.makefile/ shared=true

$(DESTLUALIB).$(PLAT_MACOS).$(LIB_EXT) : $(DESTLUALIBS_MACOS)
	$(LIPO_MACOS) -create -output $@ $^

$(DESTLUALIB).$(PLAT_IOS).$(LIB_EXT) : $(DESTLUALIBS_IOS)
	$(LIPO_IOS) -create -output $@ $^

$(DESTLIMAXLUALIB).$(PLAT_MACOS).$(LIB_EXT) : $(DESTLIMAXLUALIBS_MACOS)
	$(LIPO_MACOS) -create -output $@ $^

$(DESTLIMAXLUALIB).$(PLAT_IOS).$(LIB_EXT) : $(DESTLIMAXLUALIBS_IOS)
	$(LIPO_IOS) -create -output $@ $^

$(DESTLUALIB).$(PLAT_MACOS).$(ARCH_I386).$(LIB_EXT) :
	make -f makelualib.mk $(LIB_LUA_MACOS_I386_VARS)

$(DESTLUALIB).$(PLAT_MACOS).$(ARCH_X86_64).$(LIB_EXT) :
	make -f makelualib.mk $(LIB_LUA_MACOS_X86_64_VARS)

$(DESTLUALIB).$(PLAT_IOS).$(ARCH_ARMV7).$(LIB_EXT) :
	make -f makelualib.mk $(LIB_LUA_IOS_ARMV7_VARS)

$(DESTLUALIB).$(PLAT_IOS).$(ARCH_ARMV7S).$(LIB_EXT) :
	make -f makelualib.mk $(LIB_LUA_IOS_ARMV7S_VARS)

$(DESTLUALIB).$(PLAT_IOS).$(ARCH_ARM64).$(LIB_EXT) :
	make -f makelualib.mk $(LIB_LUA_IOS_ARM64_VARS)

$(DESTLUALIB).$(PLAT_SIMULATOR).$(ARCH_I386).$(LIB_EXT) :
	make -f makelualib.mk $(LIB_LUA_SIMULATOR_I386_VARS)

$(DESTLUALIB).$(PLAT_SIMULATOR).$(ARCH_X86_64).$(LIB_EXT) :
	make -f makelualib.mk $(LIB_LUA_SIMULATOR_X86_64_VARS)

$(DESTLIMAXLUALIB).$(PLAT_MACOS).$(ARCH_I386).$(LIB_EXT) : $(DESTLUALIB).$(PLAT_MACOS).$(ARCH_I386).$(LIB_EXT)
	make -f makelib.mk $(LIB_LIMAXLUA_MACOS_I386_VARS)

$(DESTLIMAXLUALIB).$(PLAT_MACOS).$(ARCH_X86_64).$(LIB_EXT) : $(DESTLUALIB).$(PLAT_MACOS).$(ARCH_X86_64).$(LIB_EXT)
	make -f makelib.mk $(LIB_LIMAXLUA_MACOS_X86_64_VARS)

$(DESTLIMAXLUALIB).$(PLAT_IOS).$(ARCH_ARMV7).$(LIB_EXT) : $(DESTLUALIB).$(PLAT_IOS).$(ARCH_ARMV7).$(LIB_EXT)
	make -f makelib.mk $(LIB_LIMAXLUA_IOS_ARMV7_VARS)

$(DESTLIMAXLUALIB).$(PLAT_IOS).$(ARCH_ARMV7S).$(LIB_EXT) : $(DESTLUALIB).$(PLAT_IOS).$(ARCH_ARMV7S).$(LIB_EXT)
	make -f makelib.mk $(LIB_LIMAXLUA_IOS_ARMV7S_VARS)

$(DESTLIMAXLUALIB).$(PLAT_IOS).$(ARCH_ARM64).$(LIB_EXT) : $(DESTLUALIB).$(PLAT_IOS).$(ARCH_ARM64).$(LIB_EXT)
	make -f makelib.mk $(LIB_LIMAXLUA_IOS_ARM64_VARS)

$(DESTLIMAXLUALIB).$(PLAT_SIMULATOR).$(ARCH_I386).$(LIB_EXT) : $(DESTLUALIB).$(PLAT_SIMULATOR).$(ARCH_I386).$(LIB_EXT)
	make -f makelib.mk $(LIB_LIMAXLUA_SIMULATOR_I386_VARS)

$(DESTLIMAXLUALIB).$(PLAT_SIMULATOR).$(ARCH_X86_64).$(LIB_EXT) : $(DESTLUALIB).$(PLAT_SIMULATOR).$(ARCH_X86_64).$(LIB_EXT)
	make -f makelib.mk $(LIB_LIMAXLUA_SIMULATOR_X86_64_VARS)

arm64 : $(DESTLIMAXLUALIBS_ARM64)

lualib : $(LUALIB_DEPS)

luas : $(DESTLUALIB).$(PLAT_MACOS).$(ARCH_X86_64).$(LIB_EXT) $(DESTLIMAXLUALIB).$(PLAT_MACOS).$(ARCH_X86_64).$(LIB_EXT)
	make -f makelualib.mk $(LIB_LUA_MACOS_X86_64_VARS) luas

all: clean main luas 

cleanlimaxlua :
	make -f makelib.mk $(LIB_LIMAXLUA_MACOS_I386_VARS) clean
	make -f makelib.mk $(LIB_LIMAXLUA_MACOS_X86_64_VARS) clean
	make -f makelib.mk $(LIB_LIMAXLUA_IOS_ARMV7_VARS) clean
	make -f makelib.mk $(LIB_LIMAXLUA_IOS_ARMV7S_VARS) clean
	make -f makelib.mk $(LIB_LIMAXLUA_IOS_ARM64_VARS) clean
	make -f makelib.mk $(LIB_LIMAXLUA_SIMULATOR_I386_VARS) clean
	make -f makelib.mk $(LIB_LIMAXLUA_SIMULATOR_X86_64_VARS) clean
	$(RM) $(MAIN_DEPS)

clean : cleanlimaxlua
	make -f makelualib.mk $(LIB_LUA_MACOS_I386_VARS) clean
	make -f makelualib.mk $(LIB_LUA_MACOS_X86_64_VARS) clean
	make -f makelualib.mk $(LIB_LUA_IOS_ARMV7_VARS) clean
	make -f makelualib.mk $(LIB_LUA_IOS_ARMV7S_VARS) clean
	make -f makelualib.mk $(LIB_LUA_IOS_ARM64_VARS) clean
	make -f makelualib.mk $(LIB_LUA_SIMULATOR_I386_VARS) clean
	make -f makelualib.mk $(LIB_LUA_SIMULATOR_X86_64_VARS) clean
	
